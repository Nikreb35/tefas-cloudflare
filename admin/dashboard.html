<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEFAS Admin - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background: #f8f9fa;
            width: 250px;
        }
        .main-content {
            margin-left: 250px;
            padding: 30px;
        }
        .nav-link {
            color: #333;
            padding: 0.5rem 1rem;
        }
        .nav-link.active {
            background: #e9ecef;
        }
        .card {
            margin-bottom: 20px;
        }
        #changePasswordModal .modal-header {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="position-sticky">
            <div class="px-3 mb-4">
                <h5>TEFAS Admin</h5>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#dashboard">
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#funds">
                        Fon Yönetimi
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#visitors">
                        Ziyaretçiler
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                        Şifre Değiştir
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-danger" href="#" onclick="logout()">
                        Çıkış Yap
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Ana İçerik -->
    <main class="main-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4">Dashboard</h2>
                </div>
            </div>

            <!-- İstatistik Kartları -->
            <div class="row">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Toplam Ziyaret</h5>
                            <h2 class="card-text" id="totalVisits">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Bugünkü Ziyaret</h5>
                            <h2 class="card-text" id="todayVisits">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Aktif Fonlar</h5>
                            <h2 class="card-text" id="activeFunds">-</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Son Güncelleme</h5>
                            <p class="card-text" id="lastUpdate">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Şifre Değiştirme Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Şifre Değiştir</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label class="form-label">Mevcut Şifre</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Yeni Şifre</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Yeni Şifre (Tekrar)</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <div class="alert alert-danger" id="passwordError" style="display: none;"></div>
                        <div class="alert alert-success" id="passwordSuccess" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="changePassword()">Değiştir</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Token kontrolü
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = 'index.html';
        }

        // Verileri yükle
        async function loadData() {
            try {
                const response = await fetch('https://tefas-admin.techbrkn.workers.dev/admin/data', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('API erişim hatası');
                }

                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.error('Veri yükleme hatası:', error);
            }
        }

        // Dashboard verilerini güncelle
        function updateDashboard(data) {
            // Toplam ziyaret
            document.getElementById('totalVisits').textContent = data.stats?.totalVisits || 0;
            
            // Bugünkü ziyaret
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayVisits').textContent = data.stats?.daily?.[today] || 0;
            
            // Aktif fonlar
            document.getElementById('activeFunds').textContent = Object.keys(data.funds || {}).length;
            
            // Son güncelleme
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('tr-TR');
        }

        // Şifre değiştirme
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorElement = document.getElementById('passwordError');
            const successElement = document.getElementById('passwordSuccess');

            errorElement.style.display = 'none';
            successElement.style.display = 'none';

            // Şifre kontrolü
            if (currentPassword !== token) {
                errorElement.textContent = 'Mevcut şifre hatalı!';
                errorElement.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorElement.textContent = 'Yeni şifreler eşleşmiyor!';
                errorElement.style.display = 'block';
                return;
            }

            try {
                // Worker'a şifre değiştirme isteği gönder
                const response = await fetch('https://tefas-admin.techbrkn.workers.dev/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });

                if (!response.ok) {
                    throw new Error('Şifre değiştirme başarısız');
                }

                // Başarılı
                successElement.textContent = 'Şifre başarıyla değiştirildi!';
                successElement.style.display = 'block';
                
                // LocalStorage'ı güncelle
                localStorage.setItem('adminToken', newPassword);
                
                // Formu temizle
                document.getElementById('changePasswordForm').reset();
                
                // 2 saniye sonra modalı kapat
                setTimeout(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();
                }, 2000);

            } catch (error) {
                errorElement.textContent = 'Sistem hatası: ' + error.message;
                errorElement.style.display = 'block';
            }
        }

        // Çıkış yap
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'index.html';
        }

        // Sayfa yüklendiğinde verileri getir
        document.addEventListener('DOMContentLoaded', loadData);

        // Her 60 saniyede bir verileri güncelle
        setInterval(loadData, 60000);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 